# –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
from flask import Flask, request, jsonify
import logging

# —Å–æ–∑–¥–∞—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
# –º—ã –ø–µ—Ä–µ–¥–∞—ë–º name, –≤ –Ω—ë–º —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è,
# –≤ –∫–∞–∫–æ–º –º–æ–¥—É–ª–µ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è.
# –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ —Ç–∞–º —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è '__main__',
# —Ç–∞–∫ –∫–∞–∫ –º—ã –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏–∑ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –º–æ–¥—É–ª—è.
# –µ—Å–ª–∏ –±—ã —Ç–∞–∫–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥—É–ª—è logging,
# —Ç–æ –º—ã –±—ã –ø–æ–ª—É—á–∏–ª–∏ 'logging'
app = Flask(__name__)

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –°–æ–∑–¥–∞–¥–∏–º —Å–ª–æ–≤–∞—Ä—å, —á—Ç–æ–±—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏ –æ–±—â–µ–Ω–∏—è
# —Å –Ω–∞–≤—ã–∫–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—Å—å –ø–æ–¥—Å–∫–∞–∑–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–µ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
# –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º –Ω–µ–º–Ω–æ–≥–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤
# (buttons –≤ JSON –æ—Ç–≤–µ—Ç–∞).
# –ö–æ–≥–¥–∞ –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—à–µ—Ç –Ω–∞—à–µ–º—É –Ω–∞–≤—ã–∫—É,
# —Ç–æ –º—ã —Å–æ—Ö—Ä–∞–Ω–∏–º –≤ —ç—Ç–æ—Ç —Å–ª–æ–≤–∞—Ä—å –∑–∞–ø–∏—Å—å —Ñ–æ—Ä–º–∞—Ç–∞
# sessionStorage[user_id] = {'suggests': ["–ù–µ —Ö–æ—á—É.", "–ù–µ –±—É–¥—É.", "–û—Ç—Å—Ç–∞–Ω—å!" ]}
# –¢–∞–∫–∞—è –∑–∞–ø–∏—Å—å –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ –º—ã –ø–æ–∫–∞–∑–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —ç—Ç–∏ —Ç—Ä–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏.
# –ö–æ–≥–¥–∞ –æ–Ω –æ—Ç–∫–∞–∂–µ—Ç—Å—è –∫—É–ø–∏—Ç—å —Å–ª–æ–Ω–∞,
# —Ç–æ –º—ã —É–±–µ—Ä–µ–º –æ–¥–Ω—É –ø–æ–¥—Å–∫–∞–∑–∫—É. –ö–∞–∫ –±—É–¥—Ç–æ —á—Ç–æ-—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è üôÇ
sessionStorage = {}


@app.route('/post', methods=['POST'])
# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–∞–µ—Ç —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç.
# –í–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–µ–Ω request.json - —ç—Ç–æ JSON,
# –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–∏–ª–∞ –Ω–∞–º –ê–ª–∏—Å–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ POST
def main():
    logging.info(f'Request: {request.json!r}')

    # –ù–∞—á–∏–Ω–∞–µ–º —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç, —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
    # –º—ã —Å–æ–±–∏—Ä–∞–µ–º —Å–ª–æ–≤–∞—Ä—å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ—Ç–æ–º –æ—Ç–¥–∞–¥–∏–º –ê–ª–∏—Å–µ
    response = {
        'session': request.json['session'],
        'version': request.json['version'],
        'response': {
            'end_session': False
        }
    }

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º request.json –∏ response –≤ —Ñ—É–Ω–∫—Ü–∏—é handle_dialog.
    # –û–Ω–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø–æ–ª—è JSON, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–≤–µ—á–∞—é—Ç
    # –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞ –≤–µ–¥–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
    handle_dialog(request.json, response)

    logging.info(f'Response:  {response!r}')

    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞–µ–º –≤ JSON –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
    return jsonify(response)


def handle_dialog(req, res):
    user_id = req['session']['user_id']

    if req['session']['new']:
        # –≠—Ç–æ –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Å—Å–∏—é –∏ –ø–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –µ–≥–æ.
        # –ó–∞–ø–∏—à–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –µ–º—É –ø–æ–∫–∞–∂–µ–º –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑

        sessionStorage[user_id] = {
            'suggests': [
                "–ù–µ —Ö–æ—á—É.",
                "–ù–µ –±—É–¥—É.",
                "–û—Ç—Å—Ç–∞–Ω—å!",
            ]
        }
        # –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
        res['response']['text'] = '–ü—Ä–∏–≤–µ—Ç! –ö—É–ø–∏ —Å–ª–æ–Ω–∞!'
        # –ü–æ–ª—É—á–∏–º –ø–æ–¥—Å–∫–∞–∑–∫–∏
        res['response']['buttons'] = get_suggests(user_id)
        return

    # –°—é–¥–∞ –¥–æ–π–¥–µ–º —Ç–æ–ª—å–∫–æ, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–æ–≤—ã–π,
    # –∏ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –ê–ª–∏—Å–æ–π —É–∂–µ –±—ã–ª –Ω–∞—á–∞—Ç
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    # –í req['request']['original_utterance'] –ª–µ–∂–∏—Ç –≤–µ—Å—å —Ç–µ–∫—Å—Ç,
    # —á—Ç–æ –Ω–∞–º –ø—Ä–∏—Å–ª–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    # –ï—Å–ª–∏ –æ–Ω –Ω–∞–ø–∏—Å–∞–ª '–ª–∞–¥–Ω–æ', '–∫—É–ø–ª—é', '–ø–æ–∫—É–ø–∞—é', '—Ö–æ—Ä–æ—à–æ',
    # —Ç–æ –º—ã —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—Å–∏–ª—Å—è.
    # –ü–æ–¥—É–º–∞–π—Ç–µ, –≤—Å—ë –ª–∏ –≤ —ç—Ç–æ–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç–µ –Ω–∞–ø–∏—Å–∞–Ω–æ "–∫—Ä–∞—Å–∏–≤–æ"?
    if req['request']['original_utterance'].lower() in [
        '–ª–∞–¥–Ω–æ',
        '–∫—É–ø–ª—é',
        '–ø–æ–∫—É–ø–∞—é',
        '—Ö–æ—Ä–æ—à–æ'
    ]:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—Å–∏–ª—Å—è, –ø—Ä–æ—â–∞–µ–º—Å—è.
        res['response']['text'] = '–°–ª–æ–Ω–∞ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–ú–∞—Ä–∫–µ—Ç–µ!'
        res['response']['end_session'] = True
        return

    # –ï—Å–ª–∏ –Ω–µ—Ç, —Ç–æ —É–±–µ–∂–¥–∞–µ–º –µ–≥–æ –∫—É–ø–∏—Ç—å —Å–ª–æ–Ω–∞!
    res['response']['text'] = \
        f"–í—Å–µ –≥–æ–≤–æ—Ä—è—Ç '{req['request']['original_utterance']}', –∞ —Ç—ã –∫—É–ø–∏ —Å–ª–æ–Ω–∞!"
    res['response']['buttons'] = get_suggests(user_id)


# –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–≤–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞.
def get_suggests(user_id):
    session = sessionStorage[user_id]

    # –í—ã–±–∏—Ä–∞–µ–º –¥–≤–µ –ø–µ—Ä–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏–∑ –º–∞—Å—Å–∏–≤–∞.
    suggests = [
        {'title': suggest, 'hide': True}
        for suggest in session['suggests'][:2]
    ]

    # –£–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É, —á—Ç–æ–±—ã –ø–æ–¥—Å–∫–∞–∑–∫–∏ –º–µ–Ω—è–ª–∏—Å—å –∫–∞–∂–¥—ã–π —Ä–∞–∑.
    session['suggests'] = session['suggests'][1:]
    sessionStorage[user_id] = session
    # –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∞, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
    # —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–ú–∞—Ä–∫–µ—Ç.
    if len(suggests) < 2:
        suggests.append({
            "title": "–õ–∞–¥–Ω–æ",
            "url": "https://market.yandex.ru/search?text=—Å–ª–æ–Ω",
            "hide": True
        })

    return suggests


if __name__ == '__main__':
    app.run()